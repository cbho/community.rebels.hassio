(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?b(exports):'function'==typeof define&&define.amd?define(['exports'],b):b(a.HAWS=a.HAWS||{})})(this,function(a){'use strict';function b(F){return{type:'auth',api_password:F}}function c(){return{type:'get_states'}}function d(){return{type:'get_config'}}function e(){return{type:'get_services'}}function f(){return{type:'get_panels'}}function g(F,G,H){var I={type:'call_service',domain:F,service:G};return H&&(I.service_data=H),I}function h(F){var G={type:'subscribe_events'};return F&&(G.event_type=F),G}function j(F){return{type:'unsubscribe_events',subscription:F}}function k(){return{type:'ping'}}function l(F,G){return{type:'result',success:!1,error:{code:F,message:G}}}function m(F,G){function H(I,J,K){var L=new WebSocket(F),M=!1,N=function(){if(L.removeEventListener('close',N),M)return void K(B);if(0===I)return void K(A);var Q=-1===I?-1:I-1;setTimeout(function(){return H(Q,J,K)},1e3)},O=function(P){var Q=JSON.parse(P.data);switch(Q.type){case'auth_required':'authToken'in G?L.send(JSON.stringify(b(G.authToken))):(M=!0,L.close());break;case'auth_invalid':M=!0,L.close();break;case'auth_ok':L.removeEventListener('message',O),L.removeEventListener('close',N),L.removeEventListener('error',N),J(L);break;default:}};L.addEventListener('message',O),L.addEventListener('close',N),L.addEventListener('error',N)}return new Promise(function(I,J){return H(G.setupRetry||0,I,J)})}function n(F){return F.result}function q(F){for(var I,G={},H=0;H<F.length;H++)I=F[H],G[I.entity_id]=I;return G}function r(F,G){var H=Object.assign({},F);return H[G.entity_id]=G,H}function s(F,G){var H=Object.assign({},F);return delete H[G],H}function u(F){return F.substr(0,F.indexOf('.'))}function w(F,G){var H={};return G.attributes.entity_id.forEach(function(I){var J=F[I];J&&(H[J.entity_id]=J)}),H}var A=1,B=2,D=function(G,H){this.url=G,this.options=H||{},this.commandId=1,this.commands={},this.eventListeners={},this.closeRequested=!1,this._handleMessage=this._handleMessage.bind(this),this._handleClose=this._handleClose.bind(this)};D.prototype.setSocket=function(G){var H=this,I=this.socket;if(this.socket=G,G.addEventListener('message',this._handleMessage),G.addEventListener('close',this._handleClose),I){var J=this.commands;this.commandId=1,this.commands={},Object.keys(J).forEach(function(K){var L=J[K];L.eventType&&H.subscribeEvents(L.eventCallback,L.eventType).then(function(M){L.unsubscribe=M})}),this.fireEvent('ready')}},D.prototype.addEventListener=function(G,H){var I=this.eventListeners[G];I||(I=this.eventListeners[G]=[]),I.push(H)},D.prototype.removeEventListener=function(G,H){var I=this.eventListeners[G];if(I){var J=I.indexOf(H);-1!==J&&I.splice(J,1)}},D.prototype.fireEvent=function(G){var H=this;(this.eventListeners[G]||[]).forEach(function(I){return I(H)})},D.prototype.close=function(){this.closeRequested=!0,this.socket.close()},D.prototype.getStates=function(){return this.sendMessagePromise(c()).then(n)},D.prototype.getServices=function(){return this.sendMessagePromise(e()).then(n)},D.prototype.getPanels=function(){return this.sendMessagePromise(f()).then(n)},D.prototype.getConfig=function(){return this.sendMessagePromise(d()).then(n)},D.prototype.callService=function(G,H,I){return this.sendMessagePromise(g(G,H,I))},D.prototype.subscribeEvents=function(G,H){var I=this;return this.sendMessagePromise(h(H)).then(function(J){var K={eventCallback:G,eventType:H,unsubscribe:function(){return I.sendMessagePromise(j(J.id)).then(function(){delete I.commands[J.id]})}};return I.commands[J.id]=K,function(){return K.unsubscribe()}})},D.prototype.ping=function(){return this.sendMessagePromise(k())},D.prototype.sendMessage=function(G){this.socket.send(JSON.stringify(G))},D.prototype.sendMessagePromise=function(G){var H=this;return new Promise(function(I,J){H.commandId+=1;var K=H.commandId;G.id=K,H.commands[K]={resolve:I,reject:J},H.sendMessage(G)})},D.prototype._handleMessage=function(G){var H=JSON.parse(G.data);switch(H.type){case'event':this.commands[H.id].eventCallback(H.event);break;case'result':H.success?this.commands[H.id].resolve(H):this.commands[H.id].reject(H.error),delete this.commands[H.id];break;case'pong':break;default:}},D.prototype._handleClose=function(){var G=this;if(Object.keys(this.commands).forEach(function(J){var K=G.commands[J],L=K.reject;L&&L(l(3,'Connection lost'))}),!this.closeRequested){this.fireEvent('disconnected');var H=Object.assign({},this.options,{setupRetry:0}),I=function(J){setTimeout(function(){m(G.url,H).then(function(K){return G.setSocket(K)},function(){return I(J+1)})},1e3*Math.min(J,5))};I(0)}};var E='group.default_view';a.ERR_CANNOT_CONNECT=A,a.ERR_INVALID_AUTH=B,a.createConnection=function(F,G){return void 0===G&&(G={}),m(F,G).then(function(H){var I=new D(F,G);return I.setSocket(H),I})},a.subscribeConfig=function(F,G){return F._subscribeConfig?F._subscribeConfig(G):new Promise(function(H,I){var J=null,K=null,L=[],M=null;G&&L.push(G);var N=function(U){J=Object.assign({},J,U);for(var V=0;V<L.length;V++)L[V](J)},O=function(U,V){return N({services:Object.assign({},J.services,(W={},W[U]=V,W))});var W},S=function(){return Promise.all([F.getConfig(),F.getPanels(),F.getServices()]).then(function(U){var V=U[0],W=U[1],X=U[2];N({core:V,panels:W,services:X})})},T=function(U){U&&L.splice(L.indexOf(U),1),0===L.length&&K()};F._subscribeConfig=function(U){return U&&(L.push(U),null!==J&&U(J)),M.then(function(){return function(){return T(U)}})},M=Promise.all([F.subscribeEvents(function(U){if(null!==J){var V=Object.assign({},J.core,{components:J.core.components.concat(U.data.component)});N({core:V})}},'component_loaded'),F.subscribeEvents(function(U){if(null!==J){var Z,V=U.data,W=V.domain,X=V.service,Y=Object.assign({},J.services[W]||{},(Z={},Z[X]={description:'',fields:{}},Z));O(W,Y)}},'service_registered'),F.subscribeEvents(function(U){if(null!==J){var V=U.data,W=V.domain,X=V.service,Y=J.services[W];if(Y&&X in Y){var Z={};Object.keys(Y).forEach(function($){$!==X&&(Z[$]=Y[$])}),O(W,Z)}}},'service_removed'),S()]),M.then(function(U){var V=U[0],W=U[1],X=U[2];K=function(){removeEventListener('ready',S),V(),W(),X()},F.addEventListener('ready',S),H(function(){return T(G)})},function(){return I()})})},a.subscribeEntities=function(F,G){return F._subscribeEntities?F._subscribeEntities(G):new Promise(function(H,I){function K(){return F.getStates().then(function(Q){M=q(Q);for(var R=0;R<O.length;R++)O[R](M)})}function L(Q){Q&&O.splice(O.indexOf(Q),1),0===O.length&&(N(),F.removeEventListener('ready',K),F._subscribeEntities=null)}var M=null,N=null,O=[],P=null;G&&O.push(G),F._subscribeEntities=function(Q){return Q&&(O.push(Q),null!==M&&Q(M)),P.then(function(){return function(){return L(Q)}})},P=Promise.all([F.subscribeEvents(function(Q){if(null!=M){var R=Q.data,S=R.entity_id,T=R.new_state;M=T?r(M,T):s(M,S);for(var U=0;U<O.length;U++)O[U](M)}},'state_changed'),K()]),P.then(function(Q){var R=Q[0];N=R,F.addEventListener('ready',K),H(function(){return L(G)})},function(){return I()})})},a.getGroupEntities=w,a.splitByGroups=function(F){var G=[],H={};return Object.keys(F).forEach(function(I){var J=F[I];'group'===u(I)?G.push(J):H[I]=J}),G.forEach(function(I){return I.attributes.entity_id.forEach(function(J){delete H[J]})}),{groups:G,ungrouped:H}},a.getViewEntities=function(F,G){var H={};return G.attributes.entity_id.forEach(function(I){var J=F[I];if(J&&!J.attributes.hidden&&(H[J.entity_id]=J,'group'===u(J.entity_id))){var K=w(F,J);Object.keys(K).forEach(function(L){var M=K[L];M.attributes.hidden||(H[L]=M)})}}),H},a.extractViews=function(F){var G=[];return Object.keys(F).forEach(function(H){var I=F[H];I.attributes.view&&G.push(I)}),G.sort(function(H,I){return H.entity_id===E?-1:I.entity_id===E?1:H.attributes.order-I.attributes.order}),G},a.extractDomain=u,a.extractObjectId=function(F){return F.substr(F.indexOf('.')+1)},Object.defineProperty(a,'__esModule',{value:!0})});
