function auth(a){return{type:'auth',api_password:a}}function states(){return{type:'get_states'}}function config(){return{type:'get_config'}}function services(){return{type:'get_services'}}function panels(){return{type:'get_panels'}}function callService(a,b,c){var d={type:'call_service',domain:a,service:b};return c&&(d.service_data=c),d}function subscribeEvents(a){var b={type:'subscribe_events'};return a&&(b.event_type=a),b}function unsubscribeEvents(a){return{type:'unsubscribe_events',subscription:a}}function ping(){return{type:'ping'}}function error(a,b){return{type:'result',success:!1,error:{code:a,message:b}}}var ERR_CANNOT_CONNECT=1,ERR_INVALID_AUTH=2,ERR_CONNECTION_LOST=3;function getSocket(a,b){function c(d,e,f){var g=new WebSocket(a),h=!1,j=function(){if(g.removeEventListener('close',j),h)return void f(ERR_INVALID_AUTH);if(0===d)return void f(ERR_CANNOT_CONNECT);var m=-1===d?-1:d-1;setTimeout(function(){return c(m,e,f)},1e3)},k=function(l){var m=JSON.parse(l.data);switch(m.type){case'auth_required':'authToken'in b?g.send(JSON.stringify(auth(b.authToken))):(h=!0,g.close());break;case'auth_invalid':h=!0,g.close();break;case'auth_ok':g.removeEventListener('message',k),g.removeEventListener('close',j),g.removeEventListener('error',j),e(g);break;default:}};g.addEventListener('message',k),g.addEventListener('close',j),g.addEventListener('error',j)}return new Promise(function(d,e){return c(b.setupRetry||0,d,e)})}function extractResult(a){return a.result}var Connection=function(b,c){this.url=b,this.options=c||{},this.commandId=1,this.commands={},this.eventListeners={},this.closeRequested=!1,this._handleMessage=this._handleMessage.bind(this),this._handleClose=this._handleClose.bind(this)};Connection.prototype.setSocket=function(b){var c=this,d=this.socket;if(this.socket=b,b.addEventListener('message',this._handleMessage),b.addEventListener('close',this._handleClose),d){var e=this.commands;this.commandId=1,this.commands={},Object.keys(e).forEach(function(f){var g=e[f];g.eventType&&c.subscribeEvents(g.eventCallback,g.eventType).then(function(h){g.unsubscribe=h})}),this.fireEvent('ready')}},Connection.prototype.addEventListener=function(b,c){var d=this.eventListeners[b];d||(d=this.eventListeners[b]=[]),d.push(c)},Connection.prototype.removeEventListener=function(b,c){var d=this.eventListeners[b];if(d){var e=d.indexOf(c);-1!==e&&d.splice(e,1)}},Connection.prototype.fireEvent=function(b){var c=this;(this.eventListeners[b]||[]).forEach(function(d){return d(c)})},Connection.prototype.close=function(){this.closeRequested=!0,this.socket.close()},Connection.prototype.getStates=function(){return this.sendMessagePromise(states()).then(extractResult)},Connection.prototype.getServices=function(){return this.sendMessagePromise(services()).then(extractResult)},Connection.prototype.getPanels=function(){return this.sendMessagePromise(panels()).then(extractResult)},Connection.prototype.getConfig=function(){return this.sendMessagePromise(config()).then(extractResult)},Connection.prototype.callService=function(b,c,d){return this.sendMessagePromise(callService(b,c,d))},Connection.prototype.subscribeEvents=function(b,c){var d=this;return this.sendMessagePromise(subscribeEvents(c)).then(function(e){var f={eventCallback:b,eventType:c,unsubscribe:function(){return d.sendMessagePromise(unsubscribeEvents(e.id)).then(function(){delete d.commands[e.id]})}};return d.commands[e.id]=f,function(){return f.unsubscribe()}})},Connection.prototype.ping=function(){return this.sendMessagePromise(ping())},Connection.prototype.sendMessage=function(b){this.socket.send(JSON.stringify(b))},Connection.prototype.sendMessagePromise=function(b){var c=this;return new Promise(function(d,e){c.commandId+=1;var f=c.commandId;b.id=f,c.commands[f]={resolve:d,reject:e},c.sendMessage(b)})},Connection.prototype._handleMessage=function(b){var c=JSON.parse(b.data);switch(c.type){case'event':this.commands[c.id].eventCallback(c.event);break;case'result':c.success?this.commands[c.id].resolve(c):this.commands[c.id].reject(c.error),delete this.commands[c.id];break;case'pong':break;default:}},Connection.prototype._handleClose=function(){var b=this;if(Object.keys(this.commands).forEach(function(e){var f=b.commands[e],g=f.reject;g&&g(error(ERR_CONNECTION_LOST,'Connection lost'))}),!this.closeRequested){this.fireEvent('disconnected');var c=Object.assign({},this.options,{setupRetry:0}),d=function(e){setTimeout(function(){getSocket(b.url,c).then(function(f){return b.setSocket(f)},function(){return d(e+1)})},1e3*Math.min(e,5))};d(0)}};function createConnection(a,b){return void 0===b&&(b={}),getSocket(a,b).then(function(c){var d=new Connection(a,b);return d.setSocket(c),d})}function subscribeConfig(a,b){return a._subscribeConfig?a._subscribeConfig(b):new Promise(function(c,d){var e=null,f=null,g=[],h=null;b&&g.push(b);var j=function(q){e=Object.assign({},e,q);for(var r=0;r<g.length;r++)g[r](e)},k=function(q,r){return j({services:Object.assign({},e.services,(s={},s[q]=r,s))});var s},o=function(){return Promise.all([a.getConfig(),a.getPanels(),a.getServices()]).then(function(q){var r=q[0],s=q[1],t=q[2];j({core:r,panels:s,services:t})})},p=function(q){q&&g.splice(g.indexOf(q),1),0===g.length&&f()};a._subscribeConfig=function(q){return q&&(g.push(q),null!==e&&q(e)),h.then(function(){return function(){return p(q)}})},h=Promise.all([a.subscribeEvents(function(q){if(null!==e){var r=Object.assign({},e.core,{components:e.core.components.concat(q.data.component)});j({core:r})}},'component_loaded'),a.subscribeEvents(function(q){if(null!==e){var v,r=q.data,s=r.domain,t=r.service,u=Object.assign({},e.services[s]||{},(v={},v[t]={description:'',fields:{}},v));k(s,u)}},'service_registered'),a.subscribeEvents(function(q){if(null!==e){var r=q.data,s=r.domain,t=r.service,u=e.services[s];if(u&&t in u){var v={};Object.keys(u).forEach(function(w){w!==t&&(v[w]=u[w])}),k(s,v)}}},'service_removed'),o()]),h.then(function(q){var r=q[0],s=q[1],t=q[2];f=function(){removeEventListener('ready',o),r(),s(),t()},a.addEventListener('ready',o),c(function(){return p(b)})},function(){return d()})})}function getEntities(a){for(var d,b={},c=0;c<a.length;c++)d=a[c],b[d.entity_id]=d;return b}function updateState(a,b){var c=Object.assign({},a);return c[b.entity_id]=b,c}function removeState(a,b){var c=Object.assign({},a);return delete c[b],c}function subscribeEntities(a,b){return a._subscribeEntities?a._subscribeEntities(b):new Promise(function(c,d){function f(){return a.getStates().then(function(m){h=getEntities(m);for(var n=0;n<k.length;n++)k[n](h)})}function g(m){m&&k.splice(k.indexOf(m),1),0===k.length&&(j(),a.removeEventListener('ready',f),a._subscribeEntities=null)}var h=null,j=null,k=[],l=null;b&&k.push(b),a._subscribeEntities=function(m){return m&&(k.push(m),null!==h&&m(h)),l.then(function(){return function(){return g(m)}})},l=Promise.all([a.subscribeEvents(function(m){if(null!=h){var n=m.data,o=n.entity_id,p=n.new_state;h=p?updateState(h,p):removeState(h,o);for(var q=0;q<k.length;q++)k[q](h)}},'state_changed'),f()]),l.then(function(m){var n=m[0];j=n,a.addEventListener('ready',f),c(function(){return g(b)})},function(){return d()})})}function extractDomain(a){return a.substr(0,a.indexOf('.'))}function extractObjectId(a){return a.substr(a.indexOf('.')+1)}function getGroupEntities(a,b){var c={};return b.attributes.entity_id.forEach(function(d){var e=a[d];e&&(c[e.entity_id]=e)}),c}function splitByGroups(a){var b=[],c={};return Object.keys(a).forEach(function(d){var e=a[d];'group'===extractDomain(d)?b.push(e):c[d]=e}),b.forEach(function(d){return d.attributes.entity_id.forEach(function(e){delete c[e]})}),{groups:b,ungrouped:c}}var DEFAULT_VIEW_ENTITY_ID='group.default_view';function getViewEntities(a,b){var c={};return b.attributes.entity_id.forEach(function(d){var e=a[d];if(e&&!e.attributes.hidden&&(c[e.entity_id]=e,'group'===extractDomain(e.entity_id))){var f=getGroupEntities(a,e);Object.keys(f).forEach(function(g){var h=f[g];h.attributes.hidden||(c[g]=h)})}}),c}function extractViews(a){var b=[];return Object.keys(a).forEach(function(c){var d=a[c];d.attributes.view&&b.push(d)}),b.sort(function(c,d){return c.entity_id===DEFAULT_VIEW_ENTITY_ID?-1:d.entity_id===DEFAULT_VIEW_ENTITY_ID?1:c.attributes.order-d.attributes.order}),b}export{ERR_CANNOT_CONNECT,ERR_INVALID_AUTH,createConnection,subscribeConfig,subscribeEntities,getGroupEntities,splitByGroups,getViewEntities,extractViews,extractDomain,extractObjectId};
